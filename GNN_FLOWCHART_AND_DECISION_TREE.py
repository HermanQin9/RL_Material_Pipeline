#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
GNN + PPO 决策树和流程图 / GNN + PPO Decision Tree and Flow Diagrams
"""

CONTENT = """

╔════════════════════════════════════════════════════════════════════════════════╗
║                  一. GNN的核心作用 - 为什么我们需要GNN?                        ║
╚════════════════════════════════════════════════════════════════════════════════╝

问题 PROBLEM:
━━━━━━━━━━━━

原始特征来源 (matminer):
  ├─ 元素成分组成 (Elemental composition)
  ├─ 晶体密度 (Crystal density)
  ├─ 对称性信息 (Symmetry)
  └─ 格子参数 (Lattice parameters)

❌ 缺失的关键信息:
  ├─ 原子间的空间相互作用 (Spatial atomic interactions) ←─ GNN来救场!
  ├─ 晶体的拓扑结构 (Crystal topology) ←─ GNN来救场!
  └─ 局部化学环境 (Local chemical environment) ←─ GNN来救场!

方案 SOLUTION:
━━━━━━━━━━━━

使用GNN学习图表示:

  晶体结构                  →  图表示              →  GNN处理              →  增强特征
  ┌────────────────┐          ┌─────────────┐         ┌──────────────┐        ┌──────┐
  │  Crystal       │          │ Graph       │         │ GNN Model    │        │Enhanced
  │  Structure     │  ─────→  │ with        │  ─────→ │ (GCN/GAT/    │ ─────→ │Feature
  │                │          │ nodes &     │         │  GraphSAGE)  │        │Matrix
  │  原子坐标      │          │ edges       │         │              │        │
  │  晶体参数      │          │ 节点特征    │         │ 学习交互作用 │        │+GNN特征
  └────────────────┘          │ 边属性      │         │ 获得嵌入     │        └──────┘
                              └─────────────┘         └──────────────┘


╔════════════════════════════════════════════════════════════════════════════════╗
║              二. 三种GNN架构的工作原理和决策树                                   ║
╚════════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│ 架构1: GCN (Graph Convolutional Network) - 快速、稳定                       │
└─────────────────────────────────────────────────────────────────────────────┘

工作原理:
  对于每个原子(节点):
    1. 收集邻域原子的特征
    2. 计算平均值 (平均聚合, Mean Aggregation)
    3. 通过权重矩阵进行转换
    4. 应用激活函数
    5. 返回下一层

          邻域原子特征              GCN卷积层              激活函数
          ┌──────────┐             ┌──────────┐           ┌──────┐
    h_v ──┤ 邻域 #1  │           ┤          │           │      │
    h_u ──┤ 邻域 #2  │  MEAN ──→ │ W*feat + │  ReLU ──→ │ h'_v │
    ...──┤ 邻域 #3  │  ──→      │ b        │           │      │
          └──────────┘             └──────────┘           └──────┘
        收集信息              聚合和变换             非线性

特点:
  ✓ 速度快 (~50ms/样本)
  ✓ 参数少，不易过拟合
  ✓ 稳定性高，可预测
  ✗ 所有邻域等权重（不够灵活）

PPO何时选择GCN:
  ┌─ 如果: 数据量小或中等
  ├─ 如果: 需要快速训练
  ├─ 如果: 计算资源有限
  └─ 选择: method=0 (GCN)


┌─────────────────────────────────────────────────────────────────────────────┐
│ 架构2: GAT (Graph Attention Network) - 准确、可解释                         │
└─────────────────────────────────────────────────────────────────────────────┘

工作原理:
  对于每个原子(节点):
    1. 对每个邻域原子计算注意力权重(0-1之间)
    2. 权重代表该邻域原子的重要性
    3. 用权重加权聚合邻域信息
    4. 多头注意力并行处理

          注意力权重计算              加权聚合              激活
          ┌──────────────┐           ┌──────────┐         ┌──────┐
    h_v ─┤ 邻域 #1 α=0.8│ ×feature ┤          │         │      │
    h_u ─┤ 邻域 #2 α=0.1│ ×feature ┤ SUM     │ ReLU ─→ │ h'_v │
    ...─┤ 邻域 #3 α=0.1│ ×feature ┤          │         │      │
          └──────────────┘           └──────────┘         └──────┘
        学习重要性权重      智能聚合（不同邻域权重不同）

特点:
  ✓ 准确性高 (+4%以上)
  ✓ 可解释性强（可视化注意力）
  ✓ 自动学习邻域重要性
  ✗ 速度慢 (~80ms/样本)
  ✗ 参数多，需要更多数据

PPO何时选择GAT:
  ┌─ 如果: 准确性最重要
  ├─ 如果: 有充足计算资源
  ├─ 如果: 需要可解释性
  └─ 选择: method=1 (GAT)


┌─────────────────────────────────────────────────────────────────────────────┐
│ 架构3: GraphSAGE - 可扩展、快速                                            │
└─────────────────────────────────────────────────────────────────────────────┘

工作原理:
  对于每个原子(节点):
    1. 从邻域中随机采样K个邻域原子
    2. 只用这K个邻域的信息（不用全部）
    3. 计算邻域特征的平均值
    4. 拼接节点特征和邻域特征
    5. 通过权重矩阵变换

          采样邻域（只用部分）       均值聚合             拼接+变换
          ┌──────────────┐           ┌──────────┐         ┌──────┐
    h_v ─┤ 邻域 #1(采) │ MEAN ─→   │          │         │      │
    h_u ─┤ 邻域 #2(采)  │ ──→      │ CONCAT   │ W*feat ─→ │ h'_v │
    ...─┤ 邻域 #3(弃)  │          └──────────┘         │      │
          └──────────────┘                           └──────┘
        采样避免全遍历    快速聚合（可扩展到大图）

特点:
  ✓ 速度最快 (~40ms/样本)
  ✓ 高度可扩展（即使图很大）
  ✓ 支持归纳学习（新结构也能处理）
  ✗ 采样随机性（稳定性略差）
  ✗ 准确性可能略低

PPO何时选择GraphSAGE:
  ┌─ 如果: 晶体结构很大(1000+原子)
  ├─ 如果: 需要最快速度
  ├─ 如果: 泛化能力重要
  └─ 选择: method=2 (GraphSAGE)


╔════════════════════════════════════════════════════════════════════════════════╗
║              三. PPO的完整选择空间 / PPO Decision Space                         ║
╚════════════════════════════════════════════════════════════════════════════════╝

PPO可以调整的参数 / PPO Tunable Parameters:

┌────────────────────────────────────────────────────────────┐
│ 选择1: GNN方法 (action['method'])                          │
├────────────────────────────────────────────────────────────┤
│ 0 → GCN        │ 速度⭐⭐⭐⭐ | 准确⭐⭐⭐⭐ | 推荐大多数场景  │
│ 1 → GAT        │ 速度⭐⭐⭐ | 准确⭐⭐⭐⭐⭐ | 推荐关键任务   │
│ 2 → GraphSAGE  │ 速度⭐⭐⭐⭐⭐ | 准确⭐⭐⭐⭐ | 推荐大规模图  │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│ 选择2: 输出维度 (action['param'])                          │
├────────────────────────────────────────────────────────────┤
│ param ∈ [0.00-0.33) → dim=8   | 轻量级 | 快速   | 信息少  │
│ param ∈ [0.33-0.67) → dim=16  | 标准   | 平衡   | 推荐   │
│ param ∈ [0.67-1.00] → dim=32  | 重量级 | 慢速   | 信息多  │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│ (可扩展) 选择3: 其他参数                                    │
├────────────────────────────────────────────────────────────┤
│ 截断距离      │ 3.0~10.0 Å  │ 影响邻域大小         │
│ 聚合方式       │ mean/sum/max│ 影响信息压缩方式      │
│ 邻域大小       │ 1~20个邻域  │ 影响采样（GraphSAGE）│
└────────────────────────────────────────────────────────────┘

总选择空间:
  ├─ 基础: 3 (方法) × 3 (维度) = 9 种
  └─ 扩展: 9 × 多种其他参数 = 数百万种可能!


╔════════════════════════════════════════════════════════════════════════════════╗
║              四. PPO的决策流程 / PPO Decision Flow                              ║
╚════════════════════════════════════════════════════════════════════════════════╝

           当前管道状态
               ⬇
    ┌──────────────────────────┐
    │ 观察 (Observation)       │
    │ ├─ 数据量                │
    │ ├─ 验证R²                │
    │ ├─ 训练进度              │
    │ └─ 计算资源              │
    └──────────────────────────┘
               ⬇
    ┌──────────────────────────────────────────┐
    │ PPO策略网络评估                          │
    │ (Policy Network: State → Action Probs)  │
    └──────────────────────────────────────────┘
               ⬇
    ┌─────────────────────────────────┐
    │ 选择GNN方法 / Choose GNN Method │
    │                                 │
    │  如果 (If):                     │
    │  ├─ 验证R²下降 → GAT (更强)    │
    │  ├─ 收敛良好 → GCN (稳定)     │
    │  └─ 数据很大 → SAGE (快速)    │
    └─────────────────────────────────┘
               ⬇
    ┌─────────────────────────────────┐
    │ 选择输出维度 / Choose Dim       │
    │                                 │
    │  如果 (If):                     │
    │  ├─ 信息不足 → 32维 (多信息)   │
    │  ├─ 平衡点 → 16维 (推荐)      │
    │  └─ 参数过多 → 8维 (简单)     │
    └─────────────────────────────────┘
               ⬇
    ┌──────────────────────────┐
    │ 执行GNN处理             │
    │ ├─ 构建晶体图            │
    │ ├─ 初始化GNN模型         │
    │ ├─ 前向传播提取特征      │
    │ └─ 融合特征到矩阵        │
    └──────────────────────────┘
               ⬇
    ┌──────────────────────────┐
    │ 评估奖励 / Compute Reward│
    │ ├─ 测量新的验证R²       │
    │ ├─ 计算R²改进量         │
    │ ├─ 测量处理时间         │
    │ └─ 综合奖励 = α*改进-β*成本
    └──────────────────────────┘
               ⬇
    ┌──────────────────────────┐
    │ PPO更新策略网络         │
    │ (Update using GAE)       │
    └──────────────────────────┘
               ⬇
    迭代继续 / Next Episode


╔════════════════════════════════════════════════════════════════════════════════╗
║              五. PPO决策案例 / PPO Decision Examples                            ║
╚════════════════════════════════════════════════════════════════════════════════╝

案例1: 数据充足、追求准确性 / Case 1: Abundant Data, Accuracy Priority
────────────────────────────────────────────────────────────────────────

情景: 有4000个材料数据，需要最高准确性预测

观察 (Observation):
  ├─ 数据量: 4000 (充足)
  ├─ 验证R²: 0.85 (良好但可改进)
  ├─ 计算资源: GPU可用 (充足)
  └─ 目标: 最大化准确性

PPO决策:
  1️⃣ 选择方法: GAT (准确性最高)
      ├─ 理由: 注意力机制学习最重要的原子
      └─ 奖励: R² +0.04 (显著提升)
  
  2️⃣ 选择维度: 32维 (重量级)
      ├─ 理由: 充足数据支持复杂模型
      └─ 代价: 处理时间+30ms

最终动作:
  action = {
    'node': 4,
    'method': 1,      # GAT
    'param': 0.85     # 32维输出
  }

期望结果:
  ├─ 新R²: 0.88-0.89 (从0.85)
  ├─ 处理时间: ~80ms/样本
  └─ 总改进: 优秀 (准确性优先)


案例2: 数据稀疏、时间紧张 / Case 2: Sparse Data, Time Pressure
────────────────────────────────────────────────────────────────────

情景: 只有200个材料，需要快速完成训练

观察 (Observation):
  ├─ 数据量: 200 (稀疏)
  ├─ 验证R²: 0.80 (较低)
  ├─ 计算资源: CPU only (有限)
  └─ 目标: 快速完成，防止过拟合

PPO决策:
  1️⃣ 选择方法: GCN (快速、稳定)
      ├─ 理由: 数据少，复杂模型易过拟合
      └─ 速度: ~50ms/样本
  
  2️⃣ 选择维度: 8维 (轻量级)
      ├─ 理由: 参数少，不易过拟合
      └─ 信息: 精简但充分

最终动作:
  action = {
    'node': 4,
    'method': 0,      # GCN
    'param': 0.15     # 8维输出
  }

期望结果:
  ├─ 新R²: 0.82 (从0.80, 小幅改进)
  ├─ 处理时间: ~50ms/样本 (快)
  └─ 总评价: 好的平衡 (速度+稳定性)


案例3: 超大晶体结构 / Case 3: Very Large Crystal Structures
────────────────────────────────────────────────────────────────────

情景: 处理包含1000+个原子的超大晶体结构

观察 (Observation):
  ├─ 结构大小: 1000+ 原子 (超大)
  ├─ 验证R²: 0.82 (中等)
  ├─ 内存限制: 受限
  └─ 目标: 可扩展处理，不崩溃

PPO决策:
  1️⃣ 选择方法: GraphSAGE (可扩展)
      ├─ 理由: 采样邻域，不用处理全图
      └─ 速度: ~40ms/样本 (最快)
  
  2️⃣ 选择维度: 16维 (标准)
      ├─ 理由: 平衡信息和内存
      └─ 内存: 管理良好

最终动作:
  action = {
    'node': 4,
    'method': 2,      # GraphSAGE
    'param': 0.50     # 16维输出
  }

期望结果:
  ├─ 新R²: 0.84 (从0.82)
  ├─ 处理时间: ~40ms/样本 (最快)
  ├─ 内存占用: 管理良好
  └─ 总评价: 优秀 (可扩展性)


╔════════════════════════════════════════════════════════════════════════════════╗
║              六. 总结：GNN与PPO的协同 / Summary: GNN + PPO Synergy              ║
╚════════════════════════════════════════════════════════════════════════════════╝

GNN的角色:
  ▼ 特征工程
  ├─ 从晶体结构学习复杂特征
  ├─ 捕捉原子间的空间相互作用
  ├─ 提升预测准确性 +3-4%
  └─ 三种架构平衡不同需求

PPO的角色:
  ▼ 智能选择与优化
  ├─ 自动选择最适合的GNN方法
  ├─ 自动调整输出维度
  ├─ 最大化性能与成本平衡
  └─ 自适应应对不同场景

它们的协同工作流程:
  
  PPO提出 → GNN执行 → 评估性能 → PPO学习
    ↓         ↓         ↓         ↓
  选择    生成特征    计算奖励    更新策略
  
  重复此循环...
  
  最终收敛到最优配置 (Optimal Configuration)


关键数字 / Key Numbers:

  选择空间:
  ├─ GNN方法: 3种
  ├─ 输出维度: 3种
  └─ 基础组合: 9种 (可扩展到数百万)

  性能指标:
  ├─ 准确性提升: +2-4% (R²)
  ├─ 误差降低: -10-22% (MAE)
  └─ 速度范围: 40-80ms/样本 (带全GNN)

  可调参数层次:
  ├─ Level 1: GNN方法 (质的选择)
  ├─ Level 2: 输出维度 (量的选择)
  └─ Level 3: 细节参数 (可扩展优化)

"""

if __name__ == '__main__':
    print(CONTENT)
